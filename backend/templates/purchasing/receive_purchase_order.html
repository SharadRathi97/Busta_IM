{% extends 'base.html' %}
{% block title %}Receive Purchase Order | Busta IM{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Receive Purchase Order #{{ po.id }}</h1>
  <a class="btn btn-outline-secondary btn-sm" href="{{ next_url }}">Back</a>
</div>

<div class="card card-soft mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-12 col-md-3"><strong>Vendor:</strong> {{ po.vendor.name }}</div>
      <div class="col-12 col-md-2"><strong>Date:</strong> {{ po.order_date }}</div>
      <div class="col-12 col-md-3"><strong>Status:</strong> {{ po.get_status_display }}</div>
      <div class="col-12 col-md-4"><strong>Notes:</strong> {{ po.notes|default:"-" }}</div>
    </div>
  </div>
</div>

<div class="card card-soft">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ next_url }}">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Line Items</h2>
        <button type="button" id="fill-pending" class="btn btn-sm btn-outline-primary">Fill Pending</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Material</th>
              <th>Ordered</th>
              <th>Received</th>
              <th>Pending</th>
              <th>Receive Now</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr>
                <td>{{ item.material.name }} <span class="text-muted">({{ item.material.code }})</span></td>
                <td>{{ item.quantity }} {{ item.unit }}</td>
                <td>{{ item.received_quantity }} {{ item.unit }}</td>
                <td>{{ item.pending_quantity }} {{ item.unit }}</td>
                <td>
                  {% if po.can_receive and item.pending_quantity > 0 %}
                    <input
                      type="number"
                      name="receive_{{ item.id }}"
                      class="form-control form-control-sm receive-input"
                      step="0.001"
                      min="0"
                      max="{{ item.pending_quantity }}"
                      data-pending="{{ item.pending_quantity }}"
                      value="0"
                    >
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5">No line items found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if po.can_receive %}
        <button type="submit" class="btn btn-success">Receive Selected Quantities</button>
      {% else %}
        <div class="alert alert-info mb-0">This purchase order cannot receive additional stock in its current status.</div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (() => {
    const fillPendingButton = document.getElementById("fill-pending");
    if (!fillPendingButton) {
      return;
    }
    fillPendingButton.addEventListener("click", () => {
      document.querySelectorAll(".receive-input").forEach((input) => {
        const pending = input.getAttribute("data-pending");
        input.value = pending || "0";
      });
    });
  })();
</script>
{% endblock %}
